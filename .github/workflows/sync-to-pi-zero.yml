name: Sync to Pi Zero W (10x10 Matrix)

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Sync code to Pi
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.PI_HOST }}
        username: ${{ secrets.PI_USER }}
        key: ${{ secrets.PI_SSH_KEY }}
        port: ${{ secrets.PI_PORT }}
        script: |
          # Handle existing directory
          if [ -d ~/LightBox_2.0 ]; then
            echo "Directory exists, checking if it's a git repo..."
            cd ~/LightBox_2.0
            if [ -d .git ]; then
              echo "Updating existing repository..."
              git reset --hard HEAD
              git clean -fd
              git pull origin main
            else
              echo "Directory exists but not a git repo, removing and cloning fresh..."
              cd ~
              rm -rf LightBox_2.0
              git clone https://github.com/fieldjoshua/LightBox_2.0.git
            fi
          else
            echo "Cloning fresh repository..."
            cd ~
            git clone https://github.com/fieldjoshua/LightBox_2.0.git
          fi
          
          cd ~/LightBox_2.0
          
          # Install/update dependencies
          echo "Updating dependencies..."
          pip3 install -r requirements-optimized.txt
          
          echo "Sync complete! Code is up to date."
          echo "To run: cd ~/LightBox_2.0 && sudo python3 lightbox.py"